<!doctype html>
<html lang="zh-CN" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh-CN/blog/rss.xml" title="Datafuse Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-CN/blog/atom.xml" title="Datafuse Blog Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/zh-CN/weekly/rss.xml" title="Datafuse Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-CN/weekly/atom.xml" title="Datafuse Blog Atom Feed"><title data-react-helmet="true">Proposal: Join framework | Datafuse</title><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/zh-CN/docs/development/rfcs/join-framework"><meta data-react-helmet="true" name="docusaurus_locale" content="zh-CN"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Proposal: Join framework | Datafuse"><meta data-react-helmet="true" name="description" content="Background"><meta data-react-helmet="true" property="og:description" content="Background"><link data-react-helmet="true" rel="shortcut icon" href="/zh-CN/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/zh-CN/docs/development/rfcs/join-framework"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/development/rfcs/join-framework" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/zh-CN/docs/development/rfcs/join-framework" hreflang="zh-CN"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/docs/development/rfcs/join-framework" hreflang="x-default"><link rel="stylesheet" href="/zh-CN/assets/css/styles.034f4e54.css">
<link rel="preload" href="/zh-CN/assets/js/runtime~main.07da80af.js" as="script">
<link rel="preload" href="/zh-CN/assets/js/main.22433080.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-CN/"><img src="/zh-CN/img/favicon.png" alt="Datafuse Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/zh-CN/img/favicon.png" alt="Datafuse Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Datafuse</b></a><a class="navbar__item navbar__link navbar__link--active" href="/zh-CN/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/zh-CN/blog">Blog</a><a class="navbar__item navbar__link" href="/zh-CN/weekly">Weekly</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>ä¸­æ–‡ï¼ˆä¸­å›½ï¼‰</span></span></a><ul class="dropdown__menu"><li><a href="/docs/development/rfcs/join-framework" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh-CN/docs/development/rfcs/join-framework" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ä¸­æ–‡ï¼ˆä¸­å›½ï¼‰</a></li></ul></div><a href="https://github.com/datafuselabs/datafuse" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/zh-CN/docs/intro">Why is Datafuse?</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Overview</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">SQL Reference</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">API</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Deveplop Tutorial</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/development/development-contributing">Contribution Guide</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/development/development-codingguidelines">Coding Guidelines</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/development/development-tracing">Tracing in Datafuse</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/development/development-howtoprofile">How to profile Datafuse</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/development/development-roadmap">Roadmap 2021</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">RFCs</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/zh-CN/docs/development/rfcs/join-framework">Proposal: Join framework</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/development/rfcs/DatafuseQuery-Expression">DatafuseQuery Expression</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/development/rfcs/DatafuseQuery-Shuffle">DatafuseQuery Shuffle</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/development/rfcs/datafuse-store-design">DatafuseStore Design</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/development/rfcs/Performance-Test">Performance Test</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/development/rfcs/DatafuseCli-Design">DatafuseCli Design</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">policies</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">Proposal: Join framework</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="background"></a>Background<a class="hash-link" href="#background" title="Direct link to heading">#</a></h2><p>Join is one of the major features in SQL. Meanwhile, it&#x27;s the most complicated part either.</p><p>Thus in this section, we will make a brief introduction to types of join semantics and join algorithms.</p><p>Generally, join can be categorized as following types by semantic:</p><ul><li><code>INNER JOIN</code>: return all tuples satisfy the join condition</li><li><code>LEFT OUTER JOIN</code>: return all tuples satisfy the join condition and the rows from left table for which no row from right table satisfies the join condition</li><li><code>RIGHT OUTER JOIN</code>: return all tuples satisfy the join condition and the rows from right table for which no row from left table satisfies the join condition</li><li><code>FULL OUTER JOIN</code>: return all tuples satisfy the join condition and the rows from a table for which no row from other table satisfies the join condition</li><li><code>CROSS JOIN</code>: cartesian product of joined tables</li></ul><p>Besides, <code>IN</code>, <code>EXISTS</code>, <code>NOT IN</code>, <code>NOT EXISTS</code> expressions can be implemented by <strong>semi-join</strong> and <strong>anti-join</strong>(known as subquery).</p><p>There are three kinds of common join algorithms:</p><ul><li>Nested-loop join</li><li>Hash join</li><li>Sort-merge join</li></ul><p>Nested-loop join is the basic join algorithm, it can be described as following pseudo code:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// Râ‹ˆS</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var innerTable = R</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var outerTable = S</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">for s &lt;- outerTable:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for r &lt;- innerTable:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if condition(r, s) == true:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            insert(result, combine(r, s))</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Before introducing hash join, we introduce the definition of <strong>equi join</strong> here. A <strong>equi join</strong> is join whose join condition is an equation(e.g. <code>r.a == s.a</code>). For the joins whose join condition is not an equation, we call them <strong>non-equi join</strong></p><p>Hash join can only work with equi join. It can be described as two phase: <strong>build phase</strong> and <strong>probe phase</strong>.</p><p>As inner table and outer table of nested-loop join, hash join will choose a table as <strong>build side</strong> and another table as <strong>probe side</strong>.</p><p>The pseudo code of hash join:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// Râ‹ˆS</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var build = R</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var probe = S</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var hashTable</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Build phase</span></span><span class="token-line" style="color:#393A34"><span class="token plain">for r &lt;- build:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var key = hash(r, condition)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    insert(hashTable, key, r)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// Probe phase</span></span><span class="token-line" style="color:#393A34"><span class="token plain">for s &lt;- probe:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var key = hash(s, condition)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if exists(hashTable, key):</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        var r = get(hashTable, key)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        insert(result, combine(r, s))</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Sort-merge join will sort the joined tables if they are not sorted by join key, and then merge them like merge sort.</p><p>Generally, a sort-merge join can only work with equi-join either, but it exists a band join optimization that can make sort-merge join work with some specific non-equi join. We won&#x27;t talk about this here since it&#x27;s a little bit out of scope.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="join-framework"></a>Join framework<a class="hash-link" href="#join-framework" title="Direct link to heading">#</a></h2><p>To implement join, we have several parts of work to be done:</p><ul><li>Support parse join statement into logical plan</li><li>Support bind column reference for joined tables</li><li>Support some basic heuristic optimization(e.g. outer join elimination, subquery elimination) and join reorder with choosing implementation</li><li>Support some join algorithms(local execution for now but design for distributed execution)</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="parser--planner"></a>Parser &amp; Planner<a class="hash-link" href="#parser--planner" title="Direct link to heading">#</a></h3><p>According to ANSI-SQL specification, joins are defined in <code>FROM</code> clause. Besides, subquery in other clauses can be translated to join(correlated subquery will be translated to semi join or anti join) in some cases.</p><p>After parsing SQL string into AST, we will build logical plan from AST with <code>PlanParser</code>.</p><p>Following bnf definition is a simplified ANSI-SQL specification of <code>FROM</code> clause:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bnf"><pre tabindex="0" class="prism-code language-bnf codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;from clause&gt; ::= FROM &lt;table reference list&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;table reference list&gt; ::= &lt;table reference&gt; [ { &lt;comma&gt; &lt;table reference&gt; }... ]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;table reference&gt; ::= &lt;table primary or joined table&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;table primary or joined table&gt; ::= &lt;table primary&gt; | &lt;joined table&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;table primary&gt; ::=</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;table or query name&gt; [ [ AS ] &lt;correlation name&gt; [ &lt;left paren&gt; &lt;derived column list&gt; &lt;right paren&gt; ] ]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   &lt;derived table&gt; [ AS ] &lt;correlation name&gt; [ &lt;left paren&gt; &lt;derived column list&gt; &lt;right paren&gt; ]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   &lt;left paren&gt; &lt;joined table&gt; &lt;right paren&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;joined table&gt; ::=</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;cross join&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   &lt;qualified join&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    |   &lt;natural join&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;cross join&gt; ::= &lt;table reference&gt; CROSS JOIN &lt;table primary&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;qualified join&gt; ::= &lt;table reference&gt; [ &lt;join type&gt; ] JOIN &lt;table reference&gt; &lt;join specification&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;natural join&gt; ::= &lt;table reference&gt; NATURAL [ &lt;join type&gt; ] JOIN &lt;table primary&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;join specification&gt; ::= &lt;join condition&gt; | &lt;named columns join&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;join condition&gt; ::= ON &lt;search condition&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;named columns join&gt; ::= USING &lt;left paren&gt; &lt;join column list&gt; &lt;right paren&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;join type&gt; ::= INNER | &lt;outer join type&gt; [ OUTER ]</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;outer join type&gt; ::= LEFT | RIGHT | FULL</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;join column list&gt; ::= &lt;column name list&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>&lt;table reference&gt;</code> concated with <code>&lt;comma&gt;</code> are cross joined. And it&#x27;s possible to find some conjunctions in <code>WHERE</code> clause as their join conditions, that is rewriting cross join into inner join.</p><p>There are many queries organized in this way that doesn&#x27;t explicitly specify join condition, for example TPCH query set.</p><p><code>sqlparser</code> library can parse a SQL string into AST. Joins are organized as a tree structure.</p><p>There are following kinds of join trees:</p><ul><li>Left deep tree</li><li>Right deep tree</li><li>Bushy tree</li></ul><p>In left deep tree, every join node&#x27;s right child is a table, for example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">      join</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     /    \</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    join   d</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   /    \</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  join   c</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> /    \</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">a      b</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In right deep tree, every join node&#x27;s left child is a table, for example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  join</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> /    \</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">a   join</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   /    \</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  b   join</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">     /    \</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    c      d</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In bushy tree, all children of every join node can be either result of join or table, for example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    join</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   /    \</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  join  join</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  /  \  /  \</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">  a  b  c  d</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Most of join s can be represented as left deep tree, which is easier to optimize. We can rewrite some joins to left deep tree during parsing phase.</p><p>Here&#x27;s an example of <code>sqlparser</code> AST, the comment part is simplified AST debug string:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b </span><span class="token keyword" style="color:#00009f">NATURAL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Query {</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    with: None,</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    body: Select(</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        Select {</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">            projection: [Wildcard],</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">            from: [</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                TableWithJoins {</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                    relation: Table {</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                        name: &quot;a&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                    },</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                    joins: []</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                },</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                TableWithJoins {</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                    relation: Table {</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                        name: &quot;b&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                    },</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                    joins: [</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                        Join {</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                            relation: Table {</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                                name: &quot;c&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                            },</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                            join_operator: Inner(Natural)</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                    ]</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                },</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                TableWithJoins {</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                    relation: Table {</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                        name: &quot;d&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                    },</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                    joins: []</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">                }</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">            ],</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        }</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    ),</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">}</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The AST above can be directly represented as a bushy tree:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">    join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /    \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  join   d</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> /    \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">a     join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /    \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    b      c</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This bushy tree is equivalent to the following left deep tree so we can rewrite it in parsing phase:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">      join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /    \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    join   d</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /    \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  join   c</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> /    \</span></span><span class="token-line" style="color:#393A34"><span class="token plain">a      b</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After rewriting AST to left deep tree, we will bind the AST to concrete tables and columns with catalog. During binding, semantic checking is necessary(e.g. check whether column name is ambiguous).</p><p>To implement semantic checking and simplify the binding process, we introduce <code>Scope</code> to represent context of each query block. It will record information about available columns in current context and which table they belong to.</p><p>Columns from a parent <code>Scope</code> is visible to all of its children <code>Scope</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">struct Scope {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub parent: Arc&lt;Scope&gt;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub columns: Vec&lt;ColumnRef&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here&#x27;s an example to explain how <code>Scope</code> works:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> t0 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token keyword" style="color:#00009f">INT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> t1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b </span><span class="token keyword" style="color:#00009f">INT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> t2 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token keyword" style="color:#00009f">INT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> t0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> d </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> t2</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Scope root: [t0.a, t.b, t.c, t.d]</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">|  \</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">|   Scope t0: [a]</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">|</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Scope t: [t1.b, t2.c, d]</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">|  \</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">|   Scope t1: [b]</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">|</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">Scope t2: [c]</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Since it may exist different column with same name after join, we should identify <code>ColumnRef</code> with a unique <code>ColumnID</code>. Meanwhile, correlation names are ensured to be unique, it&#x27;s fine to identify them with name strings.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">struct ColumnRef {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub id: ColumnID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub column_name: String,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub table_name: String</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>With unique <code>ColumnID</code>, we can check whether a query is ambiguous or not and keep their original name at the same time.</p><p>For planner, we will add a variant <code>Join</code> for <code>PlanNode</code> to represent join operator:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">enum PlanNode {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Join(JoinPlan)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">enum JoinType {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Inner,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    LeftOuter,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RightOuter,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    FullOuter,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Cross</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">struct JoinPlan {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub join_type: JoinType,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub join_conditions: Vec&lt;ExpressionPlan&gt;, // Conjunctions of join condition</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub left_child: Arc&lt;PlanNode&gt;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub right_child: Arc&lt;PlanNode&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here&#x27;s a problem that datafuse-query uses <code>arrow::datatypes::Schema</code> to represent data schema, while <code>arrow::datatypes::Schema</code> doesn&#x27;t support identify columns with <code>ColumnID</code> natively.</p><p>I suggest to introduce an internal <code>DataSchema</code> struct to represent data schema in datafuse-query, which can store more information and can be converted to <code>arrow::datatypes::Schema</code> naturally.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">struct DataSchema {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub columns: Vec&lt;Arc&lt;Column&gt;&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">struct Column {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub column_id: ColumnID,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub column_name: String,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub data_type: DataType,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub is_nullable: bool</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="optimizer"></a>Optimizer<a class="hash-link" href="#optimizer" title="Direct link to heading">#</a></h3><p>There are two kinds of optimization to be done:</p><ul><li>Heuristic optimization</li><li>Cost-based optimization</li></ul><p>The heuristic optimization(<strong>RBO</strong>, aka rule-based optimization), is the optimization which can always reduce cost of a query. Since there are too many heuristic rules, we won&#x27;t discuss this here.</p><p>The cost-based optimization uses statistic information to calculate the cost of a query. With exploring framework(e.g. Volcano optimizer, Cascades optimizer), it can choose the best execution plan.</p><p>Optimizer is the most complicated part in a SQL engine, we&#x27;d better only support limited heuristic optimization at the beginning.</p><blockquote><p>TODO: list common heuristic rules</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="execution"></a>Execution<a class="hash-link" href="#execution" title="Direct link to heading">#</a></h3><p>As we discussed in section <a href="#Background">Background</a>, join algorithms can be categorized into three kinds:</p><ul><li>Nested-loop join</li><li>Hash join</li><li>Sort-merge join</li></ul><p>Besides, there are two kinds of distributed join algorithms:</p><ul><li>Broadcast join</li><li>Repartition join(aka shuffle join)</li></ul><p>We won&#x27;t talk about detail of distributed join algorithms here, but we still need to consider about them.</p><p>Different join algorithms have advantage on different scenarios.</p><p>Nested-loop join is effective if the amount of data is relatively small. With vectorized execution model, it&#x27;s natural to implement block nested-loop join, which is a refined nested-loop join algorithm. Another advantage of nested-loop join is it can work with non-equi join condition.</p><p>Hash join is effective if one of the joined table is small and the other one is large. Since distributed join algorithm will always produce small tables(by partition), it fits hash join a lot. Meanwhile, vectorized hash join algorithm has been introduced by <strong>Marcin Zucowski</strong>(Co-founder of Snowflake, Phd of CWI). The disadvantage of hash join is that hash join will consume more memory than other join algorithms, and it only supports equi join.</p><p>Sort-merge join is effective if inputs are sorted, while this is rarely happened.</p><p>The comparison above is much biased, in fact it can hardly say that which algorithm is better. IMO, we can implement hash join and nested-loop join first since they are more common.</p><p>Since we don&#x27;t have infrastructure(planner, optimizer) for choosing join algorithm for now, I suggest to only implement block nested-loop join at present so we can build a complete prototype.</p><p>We&#x27;are going to introduce a vectorized block nested-loop join algorithm.</p><p>Pseudo code of naive nested-loop join has been introduced in <a href="#Background">Background</a> section. As we know, nested-loop join will fetch only one row from outer table in each loop, which doen&#x27;t have good locality. Block nested-loop join is a nested-loop join that will fetch a block of data in each loop. Here we introduce the naive block nested-loop join.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">// Râ‹ˆS</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var innerTable = R</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var outerTable = S</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var result</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">for s &lt;- outerTable.fetchBlock():</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for r &lt;- innerTable.fetchBlock():</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        buffer = conditionEvalBlock(s, r)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for row &lt;- buffer:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            insert(result, row)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In vetorized execution, we can use a bit map to indicate whether a row should be return to result set or not. Then we can materialize the result later.</p><p>For example, assume we have following SQL query:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly SQL"><pre tabindex="0" class="prism-code language-SQL codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE t(a int, b int);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE t1(b int, c int);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">-- insert some rows</span></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT a, b, c FROM t INNER JOIN t1 ON t.b = t1.b;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The execution plan of this query should look like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Join (t.b = t1.b)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -&gt; TableScan t</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    -&gt; TableScan t1</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If we use the vectorized block nested-loop join algorithm introduced above, the pseudo code should look like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">var leftChild: BlockStream = scan(t)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var rightChild: BlockStream = scan(t1)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var condition: Expression = equal(column(t.b), column(t1.b))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var result</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">for l &lt;- leftChild:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for r &lt;- rightChild:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        buffer = mergeBlock(l, r)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        var bitMap: Array[boolean] = condition.eval(buffer)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        buffer.insertColumn(bitMap)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        result.insertBlock(buffer)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">materialize(result)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In datafuse-query, we can add a <code>NestedLoopJoinTransform</code> to implement vectorized block nested-loop join.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/development/rfcs/0001-join-framework-design.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh-CN/docs/development/development-roadmap"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Roadmap 2021</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh-CN/docs/development/rfcs/DatafuseQuery-Expression"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">DatafuseQuery Expression Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#background" class="table-of-contents__link">Background</a></li><li><a href="#join-framework" class="table-of-contents__link">Join framework</a><ul><li><a href="#parser--planner" class="table-of-contents__link">Parser &amp; Planner</a></li><li><a href="#optimizer" class="table-of-contents__link">Optimizer</a></li><li><a href="#execution" class="table-of-contents__link">Execution</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh-CN/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/datafuselabs/datafuse" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>weekly<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh-CN/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/datafuselabs/datafuse" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â©2021 Datafuse Labs. Built with Docusaurus.</div></div></div></footer></div>
<script src="/zh-CN/assets/js/runtime~main.07da80af.js"></script>
<script src="/zh-CN/assets/js/main.22433080.js"></script>
</body>
</html>