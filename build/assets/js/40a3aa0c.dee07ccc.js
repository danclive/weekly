"use strict";(self.webpackChunkdatafuse=self.webpackChunkdatafuse||[]).push([[8920],{3905:function(e,t,r){r.d(t,{Zo:function(){return d},kt:function(){return m}});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function o(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var l=n.createContext({}),u=function(e){var t=n.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},d=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},p=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),p=u(r),m=a,f=p["".concat(l,".").concat(m)]||p[m]||c[m]||i;return r?n.createElement(f,s(s({ref:t},d),{},{components:r})):n.createElement(f,s({ref:t},d))}));function m(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=r.length,s=new Array(i);s[0]=p;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:a,s[1]=o;for(var u=2;u<i;u++)s[u]=r[u];return n.createElement.apply(null,s)}return n.createElement.apply(null,r)}p.displayName="MDXCreateElement"},3860:function(e,t,r){r.r(t),r.d(t,{frontMatter:function(){return o},contentTitle:function(){return l},metadata:function(){return u},toc:function(){return d},default:function(){return p}});var n=r(7462),a=r(3366),i=(r(7294),r(3905)),s=["components"],o={id:"DatafuseQuery-Shuffle",title:"DatafuseQuery Shuffle",sidebar_position:3},l="Distributed query and data shuffle",u={unversionedId:"development/rfcs/DatafuseQuery-Shuffle",id:"development/rfcs/DatafuseQuery-Shuffle",isDocsHomePage:!1,title:"DatafuseQuery Shuffle",description:"Summary",source:"@site/docs/development/rfcs/0003-data-shuffle.md",sourceDirName:"development/rfcs",slug:"/development/rfcs/DatafuseQuery-Shuffle",permalink:"/docs/development/rfcs/DatafuseQuery-Shuffle",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/development/rfcs/0003-data-shuffle.md",version:"current",sidebarPosition:3,frontMatter:{id:"DatafuseQuery-Shuffle",title:"DatafuseQuery Shuffle",sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"DatafuseQuery Expression",permalink:"/docs/development/rfcs/DatafuseQuery-Expression"},next:{title:"DatafuseStore Design",permalink:"/docs/development/rfcs/datafuse-store-design"}},d=[{value:"Summary",id:"summary",children:[]},{value:"Local query",id:"local-query",children:[{value:"Parser and AST",id:"parser-and-ast",children:[]},{value:"PlanBuilder and Plan",id:"planbuilder-and-plan",children:[]},{value:"Optimizer and Plan",id:"optimizer-and-plan",children:[]},{value:"Interpreter and Processor",id:"interpreter-and-processor",children:[]}]},{value:"Distributed query",id:"distributed-query",children:[{value:"ScatterOptimizer and StagePlan",id:"scatteroptimizer-and-stageplan",children:[]},{value:"PlanScheduler and RemoteProcessor",id:"planscheduler-and-remoteprocessor",children:[]},{value:"Flight API DataStream",id:"flight-api-datastream",children:[]}]}],c={toc:d};function p(e){var t=e.components,r=(0,a.Z)(e,s);return(0,i.kt)("wrapper",(0,n.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"distributed-query-and-data-shuffle"},"Distributed query and data shuffle"),(0,i.kt)("h2",{id:"summary"},"Summary"),(0,i.kt)("p",null,"Distributed query is distributed database necessary feature.\nThis doc is intended to explain the distributed query and its data flow design."),(0,i.kt)("h2",{id:"local-query"},"Local query"),(0,i.kt)("p",null,"Let's see how normal queries run on a single database node."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"'        +------+       +------------+      +---------+\n'        |      |  AST  |            | Plan |         |\n' SQL---\x3e|Parser+------\x3e|Plan Builder+-----\x3e|Optimizer|\n'        |      |       |            |      |         |\n'        +------+       +------------+      +---+-----+\n'                                               | Plan\n'                                               v\n'                 +----------+            +-----------+\n'                 |          |  Processor |           |\n'     Data <------+DataStream|<-----------+Interpreter|\n'                 |          |            |           |\n'                 +----------+            +-----------+\n")),(0,i.kt)("h3",{id:"parser-and-ast"},"Parser and AST"),(0,i.kt)("p",null,"DataFuse uses the third-party SQL parser and its AST.\nFor more information, see: ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/ballista-compute/sqlparser-rs"},"https://github.com/ballista-compute/sqlparser-rs")),(0,i.kt)("h3",{id:"planbuilder-and-plan"},"PlanBuilder and Plan"),(0,i.kt)("p",null,"A query plan (or query execution plan) is a sequence of steps used to access data in DataFuse. It is built by PlanBuilder from AST. We also use tree to describe it(similar to AST). But it has some differences with AST:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Plan is serializable and deserializable."),(0,i.kt)("li",{parentName:"ul"},"Plan is grammatically safe, we don't worry about it."),(0,i.kt)("li",{parentName:"ul"},"Plan is used to describe the computation and data dependency, not related to syntax priority"),(0,i.kt)("li",{parentName:"ul"},"We can show it with ",(0,i.kt)("inlineCode",{parentName:"li"},"EXPLAIN SELECT ..."))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"mysql> EXPLAIN SELECT number % 3 AS key, SUM(number) AS value FROM numbers(1000) WHERE number > 10 AND number < 990 GROUP BY key ORDER BY key ASC LIMIT 10;\n+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| explain                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |\n+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Limit: 10\n  Projection: (number % 3) as key:UInt8, SUM(number) as value:UInt64\n    Sort: (number % 3):UInt8,\n      AggregatorFinal: groupBy=[[(number % 3)]], aggr=[[SUM(number)]]\n        AggregatorPartial: groupBy=[[(number % 3)]], aggr=[[SUM(number)]]\n          Expression: (number % 3):UInt8, number:UInt64 (Before GroupBy)\n            Filter: ((number > 10) AND (number < 990))\n              ReadDataSource: scan partitions: [8], scan schema: [number:UInt64], statistics: [read_rows: 1000, read_bytes: 8000] |\n+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n")),(0,i.kt)("h3",{id:"optimizer-and-plan"},"Optimizer and Plan"),(0,i.kt)("p",null,"For a query, especially a complex query, you can used different plan combinations, orders and structures to get the data . Each of the different ways will get different processing time. So we need to find a reasonable plan combination way in the shortest time, which is what the optimizer does."),(0,i.kt)("h3",{id:"interpreter-and-processor"},"Interpreter and Processor"),(0,i.kt)("p",null,"The interpreter constructs the optimized plan into an executable data stream. We pull the result of SQL by pulling the data in the stream. The calculation logic of each operator in SQL corresponds to a processor, such as FilterPlan -> FilterProcessor, ProjectionPlan -> ProjectionProcessor"),(0,i.kt)("h2",{id:"distributed-query"},"Distributed query"),(0,i.kt)("p",null,"In the cluster mode, we may have to process with some problems different from the standalone mode."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"In distributed mode, the tables to be queried are always distributed in different nodes"),(0,i.kt)("li",{parentName:"ul"},"For some scenarios, distributed processing is always efficient, such as GROUP BY with keys, JOIN"),(0,i.kt)("li",{parentName:"ul"},"For some scenarios, we have no way of distributed processing, such as LIMIT, GROUP BY without keys"),(0,i.kt)("li",{parentName:"ul"},"In order to ensure fast calculation, we need to coordinate the location of calculation and data.")),(0,i.kt)("p",null,"Let's see how normal queries run on a database cluster."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"'                                              +------+       +------------+      +------------------+\n'                                              |      |  AST  |            | Plan |    Optimizer     |\n'                                       SQL---\x3e|Parser+------\x3e|Plan Builder+-----\x3e|                  |\n'                                              |      |       |            |      | ScatterOptimizer |\n'                                              +------+       +------------+      +--------+---------+\n'                                                                                          |\n'                                        +--------------+                                  |\n'                                        |              |                                  |\n'                                     +--+ FlightStream | <------+                         |  Plan\n'                                     |  |              |        |                         |\n'                                     |  +--------------+        |                         |\n'                                     |                          |                         |\n'                                     |                          |                         |\n'                                     |                          |    Flight RPC           v\n'        +----------+    Processor    |  +--------------+        |                  +----------------+\n'        |          | RemoteProcessor |  |              |        |     do_action    |  Interpreter   |\n' Data<--+DataStream|<----------------+--+ FlightStream | <------+------------------+                |\n'        |          |                 |  |              |        |                  | PlanRescheduler|\n'        +----------+                 |  +--------------+        |                  +----------------+\n'                                     |                          |\n'                                     |                          |\n'                                     |                          |\n'                                     |                          |\n'                                     |  +--------------+        |\n'                                     |  |              |        |\n'                                     +--+ FlightStream | <------+\n'                                        |              |\n'                                        +--------------+\n")),(0,i.kt)("h3",{id:"scatteroptimizer-and-stageplan"},"ScatterOptimizer and StagePlan"),(0,i.kt)("p",null,"In Datafuse, we use ScatterOptimizer to decide the distributed computing of query. In other words, distributed query is an optimization of standalone query."),(0,i.kt)("p",null,"In ScatterOptimizer, we traverse all the plans of the query and rewrite the plan of interest(rewrite as StagePlan { kind:StageKind, input:Self }), where input is the rewritten plan, and kind is an enumeration(Normal: data is shuffled again, Expansive: data spreads from one node to multiple nodes, Convergent: data aggregation from multiple nodes to one node)"),(0,i.kt)("h3",{id:"planscheduler-and-remoteprocessor"},"PlanScheduler and RemoteProcessor"),(0,i.kt)("p",null,"In cluster mode, we extract all the StagePlans in the plan optimized by ScatterOptimizer and send them to the corresponding nodes in the cluster according to the kind."),(0,i.kt)("p",null,"For example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"mysql> EXPLAIN SELECT argMin(user, salary)  FROM (SELECT sum(number) AS salary, number%3 AS user FROM numbers_local(1000000000) GROUP BY user);\n+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| explain                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |\n+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n| Projection: argMin(user, salary):UInt64   <-- execute in local node\n  AggregatorFinal: groupBy=[[]], aggr=[[argMin(user, salary)]]\n    RedistributeStage[expr: 0]    <-- execute in all nodes of the cluster\n      AggregatorPartial: groupBy=[[]], aggr=[[argMin(user, salary)]]\n        Projection: sum(number) as salary:UInt64, (number % 3) as user:UInt8\n  AggregatorFinal: groupBy=[[(number % 3)]], aggr=[[sum(number)]]\n    RedistributeStage[expr: sipHash(_group_by_key)]   <-- execute in all nodes of the cluster\n      AggregatorPartial: groupBy=[[(number % 3)]], aggr=[[sum(number)]]\n        Expression: (number % 3):UInt8, number:UInt64 (Before GroupBy)\n          RedistributeStage[expr: blockNumber()]    <-- execute in local node\n            ReadDataSource: scan partitions: [8], scan schema: [number:UInt64], statistics: [read_rows: 1000000000, read_bytes: 8000000000] |\n+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n")),(0,i.kt)("h3",{id:"flight-api-datastream"},"Flight API DataStream"),(0,i.kt)("p",null,"We need to fetch the results of the plans sent to other nodes for execution in some way. FuseData uses the third-party library arrow-flight. more information:","[https://github.com/apache/arrow-rs/tree/master/arrow-flight]"))}p.isMDXComponent=!0}}]);